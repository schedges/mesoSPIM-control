

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mesoSPIM.src.mesoSPIM_Core &mdash; mesoSPIM Control 1.11.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=c8897f99"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            mesoSPIM Control
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">mesoSPIM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mesoSPIM Control</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mesoSPIM.src.mesoSPIM_Core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mesoSPIM.src.mesoSPIM_Core</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Core for the mesoSPIM project</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39;PyQt5 Imports&#39;&#39;&#39;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5</span><span class="w"> </span><span class="kn">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="sd">&#39;&#39;&#39; Import mesoSPIM modules &#39;&#39;&#39;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.devices.shutters.Demo_Shutter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Demo_Shutter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.devices.shutters.NI_Shutter</span><span class="w"> </span><span class="kn">import</span> <span class="n">NI_Shutter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.mesoSPIM_Camera</span><span class="w"> </span><span class="kn">import</span> <span class="n">mesoSPIM_Camera</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.devices.lasers.Demo_LaserEnabler</span><span class="w"> </span><span class="kn">import</span> <span class="n">Demo_LaserEnabler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.devices.lasers.mesoSPIM_LaserEnabler</span><span class="w"> </span><span class="kn">import</span> <span class="n">mesoSPIM_LaserEnabler</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.mesoSPIM_Serial</span><span class="w"> </span><span class="kn">import</span> <span class="n">mesoSPIM_Serial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mesoSPIM_WaveFormGenerator</span><span class="w"> </span><span class="kn">import</span> <span class="n">mesoSPIM_WaveFormGenerator</span><span class="p">,</span> <span class="n">mesoSPIM_DemoWaveFormGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.mesoSPIM_ImageWriter</span><span class="w"> </span><span class="kn">import</span> <span class="n">mesoSPIM_ImageWriter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.acquisitions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AcquisitionList</span><span class="p">,</span> <span class="n">Acquisition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.utility_functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_seconds_to_string</span><span class="p">,</span> <span class="n">format_data_size</span><span class="p">,</span> <span class="n">write_line</span><span class="p">,</span> <span class="n">replace_with_underscores</span><span class="p">,</span> <span class="n">log_cpu_core</span>


<div class="viewcode-block" id="mesoSPIM_Core">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">mesoSPIM_Core</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This class is the pacemaker of a mesoSPIM&#39;&#39;&#39;</span>

    <span class="n">sig_finished</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_update_gui_from_state</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_update_gui_from_shutter_state</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span> <span class="c1"># dirty hack to update the shutter state in the GUI</span>
    <span class="c1"># These signals have slots in both mesoSPIM_Serial and mesoSPIM_WaveFormGenerator classes. Potentially dangerous.</span>
    <span class="n">sig_state_request</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_state_request_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_stop_aquisition</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span> <span class="c1"># STOP signal to both Camera and ImageWriter threads</span>
    <span class="n">sig_position</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_status_message</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">sig_warning</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">sig_progress</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_run_timepoint</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; Camera-related signals &#39;&#39;&#39;</span>
    <span class="n">sig_prepare_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="n">Acquisition</span><span class="p">,</span> <span class="n">AcquisitionList</span><span class="p">)</span>
    <span class="n">sig_add_images_to_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="n">Acquisition</span><span class="p">,</span> <span class="n">AcquisitionList</span><span class="p">)</span>
    <span class="n">sig_end_image_series</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="n">Acquisition</span><span class="p">,</span> <span class="n">AcquisitionList</span><span class="p">)</span>
    <span class="n">sig_write_metadata</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="n">Acquisition</span><span class="p">,</span> <span class="n">AcquisitionList</span><span class="p">)</span>
    <span class="n">sig_acq_status</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">sig_prepare_live</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_get_live_image</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_get_snap_image</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">sig_end_live</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; Movement-related signals: &#39;&#39;&#39;</span>
    <span class="n">sig_move_relative</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_move_relative_and_wait_until_done</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_move_absolute</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">sig_zero_axes</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">sig_unzero_axes</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">sig_stop_movement</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_load_sample</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_unload_sample</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">sig_center_sample</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="n">sig_polling_stage_position_start</span><span class="p">,</span> <span class="n">sig_polling_stage_position_stop</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">(),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39; ETL-related signals &#39;&#39;&#39;</span>
    <span class="n">sig_save_etl_config</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtSignal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Assign the parent class to a instance variable for callbacks &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span> <span class="c1"># mesoSPIM_MainWindow class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">package_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">cfg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">state</span> <span class="c1"># mesoSPIM_StateSingleton class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;init&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_queue_display</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([],</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    

<span class="w">        </span><span class="sd">&#39;&#39;&#39; The signal-slot switchboard &#39;&#39;&#39;</span>
        <span class="c1"># Note the name duplication (shadowing)!!</span>
        <span class="c1"># parent.sig_state_request -&gt; self.state_request_handler</span>
        <span class="c1"># self.sig_state_request -&gt; self.waveformer.state_request_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_run_timepoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">run_timepoint</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_execute_script</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_script</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_move_relative</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_zero_axes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_axes</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_unzero_axes</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unzero_axes</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_stop_movement</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_movement</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_load_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_load_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_unload_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_unload_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_center_sample</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_center_sample</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sig_save_etl_config</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_save_etl_config</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_shutter_state</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_GUI_by_shutter_state</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_Camera</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_queue</span><span class="p">,</span> <span class="n">frame_queue_display</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_queue_display</span><span class="p">,</span><span class="n">timestamp_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_camera_frame</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">camera_window</span><span class="o">.</span><span class="n">update_image_from_deque</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_temperature</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">update_temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_overheat_stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">end_image_series</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">BlockingQueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_stop_aquisition</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_acq_status</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">acquisition_manager_window</span><span class="o">.</span><span class="n">AcqStatusLabel</span><span class="o">.</span><span class="n">setText</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">image_writer_thread</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span> <span class="o">=</span> <span class="n">mesoSPIM_ImageWriter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_writer_thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_write_metadata</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">BlockingQueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">end_acquisition</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">BlockingQueuedConnection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_stop_aquisition</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">abort_writing</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">sig_write_images</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">write_images</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">QueuedConnection</span><span class="p">)</span>

        <span class="c1"># The serial_worker remains in the Core thread, not separate thread for serial_worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span> <span class="o">=</span> <span class="n">mesoSPIM_Serial</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">sig_position</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_position</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">sig_pause</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_polling_stage_position_start</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">pos_timer</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_polling_stage_position_stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">pos_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_absolute</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">move_relative</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sdict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">move_relative</span><span class="p">(</span><span class="n">sdict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sdict</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">(</span><span class="n">sdict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1">#Holds precomputed moves/positions for an acquisition row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Start the threads &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="o">.</span><span class="n">HighPriority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_writer_thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="o">.</span><span class="n">HighPriority</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Setting waveform generation up &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">waveformgeneration</span> <span class="o">==</span> <span class="s1">&#39;NI&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span> <span class="o">=</span> <span class="n">mesoSPIM_WaveFormGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">waveformgeneration</span> <span class="o">==</span> <span class="s1">&#39;DemoWaveFormGeneration&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span> <span class="o">=</span> <span class="n">mesoSPIM_DemoWaveFormGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
        <span class="c1"># Signals from Core</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">state_request_handler</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Setting the shutters up &#39;&#39;&#39;</span>
        <span class="n">left_shutter_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_left&#39;</span><span class="p">]</span>
        <span class="n">right_shutter_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutterdict</span><span class="p">[</span><span class="s1">&#39;shutter_right&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutter</span> <span class="o">==</span> <span class="s1">&#39;NI&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span> <span class="o">=</span> <span class="n">NI_Shutter</span><span class="p">(</span><span class="n">left_shutter_line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span> <span class="o">=</span> <span class="n">NI_Shutter</span><span class="p">(</span><span class="n">right_shutter_line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutter</span> <span class="o">==</span> <span class="s1">&#39;Demo&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span> <span class="o">=</span> <span class="n">Demo_Shutter</span><span class="p">(</span><span class="n">left_shutter_line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span> <span class="o">=</span> <span class="n">Demo_Shutter</span><span class="p">(</span><span class="n">right_shutter_line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;shutterswitch&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="c1"># backward compatibility with older config files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;max_laser_voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;max_laser_voltage&#39;</span><span class="p">]</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Setting the laser enabler up &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laser</span> <span class="o">==</span> <span class="s1">&#39;NI&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span> <span class="o">=</span> <span class="n">mesoSPIM_LaserEnabler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laserdict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laser</span> <span class="o">==</span> <span class="s1">&#39;Demo&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span> <span class="o">=</span> <span class="n">Demo_LaserEnabler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laserdict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_framerate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;average_frame_rate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;snap_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;snap_folder&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;camera_display_live_subsampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_display_live_subsampling&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;camera_display_acquisition_subsampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">startup</span><span class="p">[</span><span class="s1">&#39;camera_display_acquisition_subsampling&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pauseflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;stage_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;TigerASI&#39;</span><span class="p">}:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span>  <span class="s1">&#39;asi_parameters&#39;</span><span class="p">),</span> <span class="s2">&quot;Config file for &#39;TigerASI&#39; must contain &#39;asi_parameters&#39; dict.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TTL_mode_enabled_in_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_config_parameter</span><span class="p">(</span><span class="s1">&#39;ttl_motion_enabled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">asi_parameters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TTL_mode_enabled_in_cfg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s2">&quot;idle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Cleans the threads up after deletion, waits until the threads</span>
<span class="sd">        have truly finished their life.</span>

<span class="sd">        Make sure to keep this up to date with the number of threads</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_writer_thread</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_writer_thread</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_request_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="nb">dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State request: Key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">, Value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            The request handling is done with exec() to write fewer lines of</span>
<span class="sd">            code.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;zoom&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;shutterconfig&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;state&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_exposure_time&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_line_interval&#39;</span><span class="p">):</span>
                <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;self.set_&#39;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;(value)&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;samplerate&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sweeptime&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ETL_cfg_file&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_ramp_rising_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_ramp_falling_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_l_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_ramp_rising_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_ramp_falling_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;etl_r_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_frequency&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_duty_cycle&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_l_phase&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_frequency&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_offset&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_duty_cycle&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_r_phase&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_pulse_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_l_max_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_pulse_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;laser_r_max_amplitude&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_delay_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_pulse_%&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_display_live_subsampling&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_display_acquisition_subsampling&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_sensor_mode&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;camera_binning&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;galvo_amp_scale_w_zoom&#39;</span><span class="p">,</span>
                       <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="n">key</span> <span class="p">:</span> <span class="n">value</span><span class="p">})</span>

<div class="viewcode-block" id="mesoSPIM_Core.set_state">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.set_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">stop_temperature_polling</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;live&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;live&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Thread name during live: &#39;</span><span class="o">+</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QThread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">objectName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;snap&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;snap&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;snap&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;run_selected_acquisition&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;run_selected_acquisition&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;run_selected_acquisition&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;selected_row&#39;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;run_acquisition_list&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;run_acquisition_list&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;run_acquisition_list&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;preview_acquisition_with_z_update&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;preview_acquisition&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_acquisition</span><span class="p">(</span><span class="n">z_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;preview_acquisition_without_z_update&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;preview_acquisition&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preview_acquisition</span><span class="p">(</span><span class="n">z_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;idle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;idle&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">start_temperature_polling</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;lightsheet_alignment_mode&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightsheet_alignment_mode&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lightsheet_alignment_mode</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;visual_mode&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;visual_mode&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span><span class="s1">&#39;live&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visual_mode</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.stop">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># This stopflag is a bit risky, needs to be updated to a more robust solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_stop_aquisition</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span> <span class="c1"># send STOP signal to both Camera and ImageWriter threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_polling_stage_position_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="c1"># clear the frame queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pauseflag</span> <span class="o">=</span> <span class="n">boolean</span>

<div class="viewcode-block" id="mesoSPIM_Core.send_progress">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.send_progress">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">cur_acq</span><span class="p">,</span>
                      <span class="n">tot_acqs</span><span class="p">,</span>
                      <span class="n">cur_image</span><span class="p">,</span>
                      <span class="n">images_in_acq</span><span class="p">,</span>
                      <span class="n">total_image_count</span><span class="p">,</span>
                      <span class="n">image_counter</span><span class="p">,</span>
                      <span class="n">time_passed_string</span><span class="p">,</span>
                      <span class="n">remaining_time_string</span><span class="p">):</span>

        <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current_acq&#39;</span><span class="p">:</span><span class="n">cur_acq</span><span class="p">,</span>
                <span class="s1">&#39;total_acqs&#39;</span> <span class="p">:</span><span class="n">tot_acqs</span><span class="p">,</span>
                <span class="s1">&#39;current_image_in_acq&#39;</span><span class="p">:</span><span class="n">cur_image</span><span class="p">,</span>
                <span class="s1">&#39;images_in_acq&#39;</span><span class="p">:</span> <span class="n">images_in_acq</span><span class="p">,</span>
                <span class="s1">&#39;total_image_count&#39;</span><span class="p">:</span><span class="n">total_image_count</span><span class="p">,</span>
                <span class="s1">&#39;image_counter&#39;</span><span class="p">:</span><span class="n">image_counter</span><span class="p">,</span>
                <span class="s1">&#39;time_passed_string&#39;</span><span class="p">:</span> <span class="n">time_passed_string</span><span class="p">,</span>
                <span class="s1">&#39;remaining_time_string&#39;</span><span class="p">:</span> <span class="n">remaining_time_string</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span></div>


    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Filter changed to &#39;</span><span class="o">+</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting filter to &#39;</span><span class="o">+</span><span class="nb">filter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done setting filter to &#39;</span><span class="o">+</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Setting magnification (zoom) to &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">zoom</span><span class="p">))</span>
        <span class="c1"># Move to the objective exchange position if necessary</span>
        <span class="n">f_pos_old</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;f_objective_exchange&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Please wait until the zoom change is complete&#39;</span><span class="p">)</span>
            <span class="n">f_pos_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;f_pos&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;f_pos_old: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">f_pos_old</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Moving to objective exchange position&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">({</span><span class="s1">&#39;f_abs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;f_objective_exchange&#39;</span><span class="p">]},</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="n">wait_until_done</span><span class="p">,</span> <span class="n">use_internal_position</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;At the objective exchange position&#39;</span><span class="p">)</span>
        <span class="c1"># Set the zoom/revolver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;zoom&#39;</span><span class="p">:</span> <span class="n">zoom</span><span class="p">})</span>
        <span class="c1"># Return to the previous f_pos</span>
        <span class="k">if</span> <span class="n">f_pos_old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Moving to the focus position&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">({</span><span class="s1">&#39;f_abs&#39;</span><span class="p">:</span> <span class="n">f_pos_old</span><span class="p">},</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="n">wait_until_done</span><span class="p">,</span> <span class="n">use_internal_position</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Magnification (zoom) changed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ZoomComboBox</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_etl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;set_etls_according_to_zoom&#39;</span><span class="p">:</span> <span class="n">zoom</span><span class="p">})</span>
        

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_laser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;laser&#39;</span> <span class="p">:</span> <span class="n">laser</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">update_etl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;set_etls_according_to_laser&#39;</span> <span class="p">:</span> <span class="n">laser</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;laser&#39;</span><span class="p">:</span><span class="n">laser</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">update_etl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;set_etls_according_to_laser&#39;</span> <span class="p">:</span> <span class="n">laser</span><span class="p">})</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span> <span class="n">intensity</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;intensity&#39;</span><span class="p">:</span><span class="n">intensity</span><span class="p">})</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_camera_exposure_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;camera_exposure_time&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_camera_line_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;camera_line_interval&#39;</span> <span class="p">:</span> <span class="n">time</span><span class="p">})</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative_and_wait_until_done</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_relative</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sdict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_internal_position</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wait_until_done</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Core: move_absolute (wait_until_done=True) has started&#39;</span><span class="p">)</span>
            <span class="c1">#self.sig_move_absolute_and_wait_until_done.emit(sdict) # THIS was running in MainWindow thread, very stubbornly, unless changed to direct call. Otherwise it was causing a lot of synchronization problems.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">sdict</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_internal_position</span><span class="o">=</span><span class="n">use_internal_position</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Core: move_absolute (wait_until_done=True) has finished&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_move_absolute</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">sdict</span><span class="p">)</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zero_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_zero_axes</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">unzero_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_unzero_axes</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop_movement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_stop_movement</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_shutterconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shutterconfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">:</span> <span class="n">shutterconfig</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_shutter_state</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">open_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Here the left/right mode is hacked in</span>
<span class="sd">        If shutterswitch = True in the config:</span>
<span class="sd">        Assumes that the shutter_left line is the general shutter </span>
<span class="sd">        and the shutter_right line is the left/right switch (Right==True)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">shutterconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Both&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Left&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="c1"># open the general shutter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># set side-switch to false </span>

        <span class="k">elif</span> <span class="n">shutterconfig</span> <span class="o">==</span> <span class="s1">&#39;Right&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="c1"># open the general shutter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="c1"># set side-switch to true</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># BOTH open</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_shutters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If shutterswitch = True in the config:</span>
<span class="sd">        Assumes that the shutter_left line is the general shutter </span>
<span class="sd">        and the shutter_right line is the left/right switch (Right==True)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutterswitch</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
          <span class="c1">#  self.shutter_left.close()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_right</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutter_left</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;shutterstate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sub-Imaging modes</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="mesoSPIM_Core.snap">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">laser_blanking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">(</span><span class="n">laser_blanking</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_snap_image</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">write_flag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.snap_image">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">snap_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser_blanking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Snaps a single image after updating the waveforms.</span>

<span class="sd">        Can be used in acquisitions where changing waveforms are required,</span>
<span class="sd">        but there is additional overhead due to the need to write the</span>
<span class="sd">        waveforms into the buffers of the NI cards.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">log_cpu_core</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;snap_image()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">laser_blanking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">laser_blanking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">disable_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span></div>

        

<div class="viewcode-block" id="mesoSPIM_Core.prepare_image_series">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_image_series">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Prepares an image series without waveform update&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">create_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">write_waveforms_to_tasks</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.snap_image_in_series">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.snap_image_in_series">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">snap_image_in_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laser_blanking</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Snaps and image from a series without waveform update&#39;&#39;&#39;</span>
        <span class="n">log_cpu_core</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;snap_image_in_series()&#39;</span><span class="p">)</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">laser_blanking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">start_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">stop_tasks</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">laser_blanking</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">disable_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.close_image_series">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_image_series">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_image_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Cleans up after series without waveform update&#39;&#39;&#39;</span>
        <span class="n">log_cpu_core</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;close_image_series()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveformer</span><span class="o">.</span><span class="n">close_tasks</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;close_image_series() finished&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.live">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.live">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">live</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">]</span>
        <span class="n">laser_blanking</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;laser_blanking&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laser_blanking</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span> <span class="s1">&#39;stacks&#39;</span><span class="p">)))</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; How to handle a possible shutter switch?&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Needs update to use snap image in series &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">(</span><span class="n">laser_blanking</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pauseflag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="c1">#Read temp </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">single_temperature_read</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">disable_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.start">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">acq_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acquisition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>
            <span class="n">acq_list</span> <span class="o">=</span> <span class="n">AcquisitionList</span><span class="p">([</span><span class="n">acquisition</span><span class="p">])</span>
            
        <span class="n">nonexisting_folders_list</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_for_nonexisting_folders</span><span class="p">()</span>
        <span class="n">filename_list</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_for_existing_filenames</span><span class="p">()</span>
        <span class="n">duplicates_list</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_for_duplicated_filenames</span><span class="p">()</span>
        <span class="n">files_without_extensions</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">check_filename_extensions</span><span class="p">()</span>
        <span class="n">free_disk_space_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_free_disk_space</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
        <span class="n">total_required_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_disk_space</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
        <span class="n">acqusitions_outside_motion_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_motion_limits</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nonexisting_folders_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;The following folders do not exist - stopping! </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">list_to_string_with_carriage_return</span><span class="p">(</span><span class="n">nonexisting_folders_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">filename_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;The following files already exist - stopping! </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">list_to_string_with_carriage_return</span><span class="p">(</span><span class="n">filename_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">duplicates_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;The following filenames are duplicated - stopping! </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">list_to_string_with_carriage_return</span><span class="p">(</span><span class="n">duplicates_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">files_without_extensions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Some files have no extensions (.raw, .tiff, .h5) - stopping! </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_to_string_with_carriage_return</span><span class="p">(</span><span class="n">files_without_extensions</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">free_disk_space_bytes</span> <span class="o">&lt;</span> <span class="n">total_required_bytes</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient disk space: </span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;Free </span><span class="si">{</span><span class="n">format_data_size</span><span class="p">(</span><span class="n">free_disk_space_bytes</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;Required </span><span class="si">{</span><span class="n">format_data_size</span><span class="p">(</span><span class="n">total_required_bytes</span><span class="p">)</span><span class="si">}</span><span class="s1">. </span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;Stopping! </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">acqusitions_outside_motion_limits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_warning</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The acquisition list contains positions </span><span class="si">{</span><span class="n">acqusitions_outside_motion_limits</span><span class="si">}</span><span class="s1"> outside the motion limits - stopping!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_acquisition_list</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.get_free_disk_space">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.get_free_disk_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_free_disk_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take the disk location of the first file and compute the free disk space&quot;&quot;&quot;</span>
        <span class="n">filename0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">acq_list</span><span class="o">.</span><span class="n">get_all_filenames</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">disk_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">filename0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
            <span class="n">free_bytes</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulonglong</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetDiskFreeSpaceExW</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">(</span><span class="n">disk_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pointer</span><span class="p">(</span><span class="n">free_bytes</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Free disk </span><span class="si">{</span><span class="n">disk_name</span><span class="si">}</span><span class="s2"> space </span><span class="si">{</span><span class="n">format_data_size</span><span class="p">(</span><span class="n">free_bytes</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">free_bytes</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># non-Windows case, untested!</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">disk_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">f_bavail</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">f_frsize</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.get_required_disk_space">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.get_required_disk_space">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_disk_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;Compute total image data size from the acquisition list, in bytes&quot;&quot;&quot;</span>
        <span class="n">BYTES_PER_PIXEL</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># 16-bit camera</span>
        <span class="n">px_per_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">x_pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">y_pixels</span>
        <span class="n">total_bytes_required</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span> <span class="o">*</span> <span class="n">px_per_image</span> <span class="o">*</span> <span class="n">BYTES_PER_PIXEL</span>
        <span class="k">return</span> <span class="n">total_bytes_required</span></div>

    
<div class="viewcode-block" id="mesoSPIM_Core.check_motion_limits">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.check_motion_limits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_motion_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the motion limits of the stage are violated for each acquisition in the given list.</span>

<span class="sd">        Args:</span>
<span class="sd">            acq_list (list): A list of dictionaries representing acquisitions, where each dictionary contains</span>
<span class="sd">                             the x, y, and z positions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of indices of acquisitions in the input list that violate the motion limits.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unsafe_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;x_min&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">acq_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;x_pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">int_x_pos_offset</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;x_max&#39;</span><span class="p">]):</span>
                <span class="n">unsafe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X is BAD&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;y_min&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">acq_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;y_pos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">int_y_pos_offset</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;y_max&#39;</span><span class="p">]):</span>
                <span class="n">unsafe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Y is BAD&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;z_min&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">acq_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;z_start&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">int_z_pos_offset</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;z_max&#39;</span><span class="p">]):</span>
                <span class="n">unsafe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZSTART is BAD&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;z_min&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">acq_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;z_end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">int_z_pos_offset</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">stage_parameters</span><span class="p">[</span><span class="s1">&#39;z_max&#39;</span><span class="p">]):</span>
                <span class="n">unsafe_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZEND is BAD&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">unsafe_list</span></div>

            
<div class="viewcode-block" id="mesoSPIM_Core.prepare_acquisition_list">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_acquisition_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Housekeeping: Prepare the acquisition list &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_acquisition_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.run_acquisition_list">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.run_acquisition_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="n">acq_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prepare_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">camera_worker</span><span class="o">.</span><span class="n">single_temperature_read</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.close_acquisition_list">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_acquisition_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_acquisition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Closing Acquisition List&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span><span class="p">:</span>
            <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
            <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq_list</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
            <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">current_rotation</span> <span class="o">&gt;</span> <span class="n">target_rotation</span><span class="o">+</span><span class="mf">0.1</span> <span class="ow">or</span> <span class="n">current_rotation</span> <span class="o">&lt;</span> <span class="n">target_rotation</span><span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">({</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">:</span><span class="n">target_rotation</span><span class="p">},</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">acq_list</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">(),</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_polling_stage_position_start</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>  <span class="c1"># resume asking stages about their position</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;laser&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;zoom&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;zoom&#39;</span><span class="p">],</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; This is for the GUI to update properly&#39;&#39;&#39;</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_offset&#39;</span> <span class="p">:</span> <span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">acq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># tiny sleep period to allow Main Window indicators to catch up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Acquisition list closed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_status_message_to_gui</span><span class="p">(</span><span class="s1">&#39;Acquisition stopped&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.preview_acquisition">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.preview_acquisition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">preview_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;selected_row&#39;</span><span class="p">]</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;acq_list&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">]</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Rotation handling goes here &#39;&#39;&#39;</span>
        <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
        <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
        <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Create a flag when rotation is required: &#39;&#39;&#39;</span>
        <span class="n">rotationflag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">current_rotation</span> <span class="o">&gt;</span> <span class="n">target_rotation</span><span class="o">+</span><span class="mf">0.1</span> <span class="ow">or</span> <span class="n">current_rotation</span> <span class="o">&lt;</span> <span class="n">target_rotation</span><span class="o">-</span><span class="mf">0.1</span> <span class="k">else</span> <span class="kc">False</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Remove z-coordinate from dict so that z is not updated during preview. If rotation necessary, z_abs is updated&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">z_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rotationflag</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;z_abs&#39;</span><span class="p">]</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39; Check if sample has to be rotated, allow some tolerance &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">rotationflag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Rotating sample&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">({</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">:</span> <span class="n">target_rotation</span><span class="p">},</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Filter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Going to start position&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">startpoint</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Shutter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_shutterconfig</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Zoom &amp; Laser&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting magnification (zoom)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">],</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Ready for preview...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.prepare_acquisition">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.prepare_acquisition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Housekeeping: Prepare the acquisition  &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Core: Running Acquisition #</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span><span class="si">}</span><span class="s1"> with Filename: </span><span class="si">{</span><span class="n">acq</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;selected_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span> <span class="c1"># this make sure that the correct row is selected in the GUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Going to start position&#39;</span><span class="p">)</span>
        <span class="n">current_rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="s1">&#39;theta_pos&#39;</span><span class="p">]</span>
        <span class="n">startpoint</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_startpoint</span><span class="p">()</span>
        <span class="n">target_rotation</span> <span class="o">=</span> <span class="n">startpoint</span><span class="p">[</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_start_time_string</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="c1"># stop asking stages about their positions, to avoid messing up serial comm during acquisition:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_polling_stage_position_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Going to start position&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Check if sample has to be rotated, allow some tolerance &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">current_rotation</span> <span class="o">&gt;</span> <span class="n">target_rotation</span><span class="o">+</span><span class="mf">0.1</span> <span class="ow">or</span> <span class="n">current_rotation</span> <span class="o">&lt;</span> <span class="n">target_rotation</span><span class="o">-</span><span class="mf">0.1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">({</span><span class="s1">&#39;theta_abs&#39;</span><span class="p">:</span> <span class="n">target_rotation</span><span class="p">},</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">move_absolute</span><span class="p">(</span><span class="n">startpoint</span><span class="p">,</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting Filter &amp; Shutter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_shutterconfig</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;shutterconfig&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Setting magnification (zoom)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_zoom</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zoom&#39;</span><span class="p">],</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_laser</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">],</span> <span class="n">wait_until_done</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_etl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; This is for the GUI to update properly&#39;&#39;&#39;</span>
        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_offset&#39;</span> <span class="p">:</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;etl_l_offset&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_f_and_z_steps</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TTL_mode_enabled_in_cfg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">first_nonzero_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">first_nonzero_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">({</span><span class="s2">&quot;x_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;y_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;z_rel&quot;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">first_nonzero_z</span><span class="p">,</span><span class="s2">&quot;f_rel&quot;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">first_nonzero_f</span><span class="p">,</span><span class="s2">&quot;theta_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">({</span><span class="s2">&quot;x_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;y_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;z_rel&quot;</span><span class="p">:</span><span class="n">first_nonzero_z</span><span class="p">,</span><span class="s2">&quot;f_rel&quot;</span><span class="p">:</span><span class="n">first_nonzero_f</span><span class="p">,</span><span class="s2">&quot;theta_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;ttl_movement_enabled_during_acq&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="c1">#Get absolute positions for tracking/writing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">report_position</span><span class="p">()</span>
        <span class="n">abs_pos_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_worker</span><span class="o">.</span><span class="n">stage</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;position_absolute&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">abs_pos_start</span><span class="p">[</span><span class="s1">&#39;z_pos&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">abs_pos_start</span><span class="p">[</span><span class="s1">&#39;f_pos&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Preparing camera: Allocating memory&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span> <span class="c1"># signal to the Camera</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">prepare_acquisition</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_image_series</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_write_metadata</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.run_acquisition">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.run_acquisition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Running Acquisition&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_start_time_string</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>

        <span class="c1">#move_dict = acq.get_delta_dict()</span>
        <span class="n">laser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;laser&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">laser</span><span class="p">)</span>
        <span class="n">laser_blanking</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;laser_blanking&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">laser_blanking</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;stack&#39;</span><span class="p">,</span> <span class="s1">&#39;stacks&#39;</span><span class="p">)))</span> <span class="k">else</span> <span class="kc">True</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snap_image_in_series</span><span class="p">(</span><span class="n">laser_blanking</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_add_images_to_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>

                <span class="c1">#Update current parameters</span>
                <span class="n">f_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">z_abs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sig_acq_status</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Displayed Slice </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">steps</span><span class="si">}</span><span class="s2"> | Z: </span><span class="si">{</span><span class="n">z_abs</span><span class="si">}</span><span class="s2">  F: </span><span class="si">{</span><span class="n">f_abs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="w">                            </span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; Get the current correct f_step and z step &#39;&#39;&#39;</span>
                <span class="n">move_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;y_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;z_rel&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;f_rel&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s2">&quot;theta_rel&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;move_dict: </span><span class="si">{</span><span class="n">move_dict</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">move_relative</span><span class="p">(</span><span class="n">move_dict</span><span class="p">)</span>

<span class="w">                </span><span class="sd">&#39;&#39;&#39; The pauseflag allows:</span>
<span class="sd">                    - pausing running acquisitions</span>
<span class="sd">                    - wait for slow hardware to catch up (e.g. slow stages)</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">pauseflag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>
                    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                
                <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QEventLoop</span><span class="o">.</span><span class="n">AllEvents</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="w">                </span><span class="sd">&#39;&#39;&#39; Keep track of passed time and predict remaining time &#39;&#39;&#39;</span>
                <span class="n">time_passed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
                <span class="n">time_remaining</span> <span class="o">=</span> <span class="n">time_passed</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span><span class="p">)</span>

<span class="w">                </span><span class="sd">&#39;&#39;&#39; Every 100 images, update the frame rate&#39;&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_framerate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">/</span> <span class="n">time_passed</span>

                <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">total_acquisition_count</span><span class="p">,</span>
                                    <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">steps</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">total_image_count</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">image_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">convert_seconds_to_string</span><span class="p">(</span><span class="n">time_passed</span><span class="p">),</span>
                                    <span class="n">convert_seconds_to_string</span><span class="p">(</span><span class="n">time_remaining</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laserenabler</span><span class="o">.</span><span class="n">disable_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_end_time_string</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abs_f_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abs_z_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.close_acquisition">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.close_acquisition">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_acquisition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;Closing Acquisition: Saving data &amp; freeing up memory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_image_series</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_image_series</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">acq_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TTL_mode_enabled_in_cfg</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to set TTL mode to False&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span> <span class="c1"># add some buffer time for serial execution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;ttl_movement_enabled_during_acq&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># buffer time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;TTL mode set to False&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acq_end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_end_time_string</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_framerate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="o">.</span><span class="n">get_image_count</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_acq_end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_timing_info_to_metadata</span><span class="p">(</span><span class="n">acq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acquisition_count</span> <span class="o">+=</span> <span class="mi">1</span></div>


    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;running_script&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_update_gui_from_state</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

<div class="viewcode-block" id="mesoSPIM_Core.lightsheet_alignment_mode">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.lightsheet_alignment_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lightsheet_alignment_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Switches shutters after each image to allow coalignment of both lightsheets&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">shutter</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;Left&#39;</span><span class="p">,</span> <span class="s1">&#39;Right&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_shutterconfig</span><span class="p">(</span><span class="n">shutter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.visual_mode">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.visual_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visual_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">old_l_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_l_amplitude&#39;</span><span class="p">]</span>
        <span class="n">old_r_amp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;etl_r_amplitude&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_prepare_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopflag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Needs update to use snap image in series &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snap_image</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig_get_live_image</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

<span class="w">            </span><span class="sd">&#39;&#39;&#39; How to handle a possible shutter switch?&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_shutters</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_shutters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_end_live</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_l_amplitude&#39;</span> <span class="p">:</span> <span class="n">old_l_amp</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;etl_r_amplitude&#39;</span> <span class="p">:</span> <span class="n">old_r_amp</span><span class="p">})</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.execute_galil_program">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.execute_galil_program">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute_galil_program</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Little helper method to execute the program loaded onto the Galil stage:</span>
<span class="sd">        allows hand controller to operate&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_state_request</span><span class="o">.</span><span class="n">emit</span><span class="p">({</span><span class="s1">&#39;stage_program&#39;</span> <span class="p">:</span> <span class="s1">&#39;execute&#39;</span><span class="p">})</span></div>


    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">pyqtSlot</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_status_message_to_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_status_message</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

<div class="viewcode-block" id="mesoSPIM_Core.list_to_string_with_carriage_return">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.list_to_string_with_carriage_return">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_to_string_with_carriage_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_list</span><span class="p">):</span>
        <span class="n">mystring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_list</span><span class="p">:</span>
            <span class="n">mystring</span> <span class="o">=</span> <span class="n">mystring</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">i</span>    
        <span class="k">return</span> <span class="n">mystring</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.read_config_parameter">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.read_config_parameter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_config_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to check if key exists in the dictionary and read its value, or throw a meaningful error&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mandatory parameter </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> not found in dictionary: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">dictionary</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> \
                      <span class="sa">f</span><span class="s2">&quot;Check config file for missing parameter </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.append_timing_info_to_metadata">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.append_timing_info_to_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append_timing_info_to_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Appends a metadata.txt file</span>
<span class="sd">        Path contains the file to be written</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_writer</span><span class="o">.</span><span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;folder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">replace_with_underscores</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">metadata_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_meta.txt&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metadata_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;TIMING INFORMATION&#39;</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Started stack&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_start_time_string</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Started taking images&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_start_time_string</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Stopped taking images&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_end_time_string</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Stopped stack&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_end_time_string</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Total time of taking images, s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_acq_end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_acq_start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Total time of stack acquisition, s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acq_end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;Frame rate during taking images, img/s:&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_framerate&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;===================== END OF ACQUISITION ======================&#39;</span><span class="p">)</span>
            <span class="n">write_line</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


<div class="viewcode-block" id="mesoSPIM_Core.run_time_lapse">
<a class="viewcode-back" href="../../../api/mesoSPIM.src.html#mesoSPIM.src.mesoSPIM_Core.mesoSPIM_Core.run_time_lapse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_time_lapse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">time_interval_sec</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;A quick and dirty implementation of time lapse via recursive function.&#39;&#39;&#39;</span>	
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">&gt;=</span> <span class="n">tpoints</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timer sequence finished&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running time point </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">tpoints</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="n">time_interval_sec</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time_lapse</span><span class="p">(</span><span class="n">tpoints</span><span class="p">,</span> <span class="n">time_interval_sec</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_run_timepoint</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_counter</span> <span class="o">+=</span> <span class="mi">1</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright mesoSPIM team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>